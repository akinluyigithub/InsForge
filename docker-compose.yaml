version: '3.8'

services:
  postgres:
    image: ghcr.io/insforge/postgres:v15.13.2
    restart: always
    command: postgres -c config_file=/etc/postgresql/postgresql.conf -c app.encryption_key='${JWT_SECRET:-dev-floating-secret}'
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-insforge}
    volumes:
      - postgres-data-v3:/var/lib/postgresql/data
      - ./deploy/docker-init/db/db-init.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./deploy/docker-init/db/jwt.sql:/docker-entrypoint-initdb.d/02-jwt.sql
      - ./deploy/docker-init/db/postgresql.conf:/etc/postgresql/postgresql.conf
    # ports:
    #   - "5432:5432"
    networks:
      - insforge-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}" ]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 60s

  postgrest:
    image: postgrest/postgrest:v12.2.12
    restart: always
    environment:
      PGRST_DB_URI: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-insforge}
      PGRST_OPENAPI_SERVER_PROXY_URI: ${API_BASE_URL:-http://localhost:7130}
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET:-dev-secret-please-change-in-production}
      PGRST_DB_CHANNEL_ENABLED: true
      PGRST_DB_CHANNEL: pgrst
    depends_on:
      - postgres
    networks:
      - insforge-network

  insforge:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:7130}
        VITE_PUBLIC_POSTHOG_KEY: ${VITE_PUBLIC_POSTHOG_KEY:-}
    restart: always
    depends_on:
      - postgres
    ports:
      - "7130:7130"
    environment:
      - PORT=7130
      - JWT_SECRET=${JWT_SECRET:-dev-secret-please-change-in-production}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-change-this-password}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-insforge}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-insforge}
      - POSTGREST_BASE_URL=http://postgrest:3000
      - DENO_RUNTIME_URL=http://deno:7133
      - LOGS_DIR=/insforge-logs
      - STORAGE_DIR=/insforge-storage
      # S3/Cloudfront (optional)
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-}
      - AWS_REGION=${AWS_REGION:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
    volumes:
      - storage-data:/insforge-storage
      - shared-logs:/insforge-logs
    networks:
      - insforge-network

  deno:
    image: denoland/deno:alpine-2.0.6
    restart: always
    working_dir: /app
    depends_on:
      - postgres
    environment:
      - PORT=7133
      - DENO_ENV=production
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-insforge}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGREST_BASE_URL=http://postgrest:3000
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-dev-floating-secret}
      - JWT_SECRET=${JWT_SECRET:-dev-secret-please-change-in-production}
    volumes:
      - ./functions:/app/functions
      - deno_cache:/deno-dir
    command: >
      sh -c "
        deno cache functions/server.ts &&
        deno run --allow-net --allow-env --allow-read=./functions/worker-template.js functions/server.ts
      "
    networks:
      - insforge-network

  vector:
    image: timberio/vector:0.28.1-alpine
    restart: always
    depends_on:
      insforge:
        condition: service_started
    volumes:
      - ./deploy/docker-init/logs/vector.yml:/etc/vector/vector.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - shared-logs:/insforge-logs
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-skip}
    command: [ "--config", "/etc/vector/vector.yml" ]
    networks:
      - insforge-network

volumes:
  postgres-data-v3:
  deno_cache:
  storage-data:
  shared-logs:


networks:
  insforge-network:
    driver: bridge
